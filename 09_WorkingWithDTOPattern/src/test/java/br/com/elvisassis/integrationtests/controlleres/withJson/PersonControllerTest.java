package br.com.elvisassis.integrationtests.controlleres.withJson;import br.com.elvisassis.config.TestConfigs;import br.com.elvisassis.integrationtests.dto.PersonDTO;import br.com.elvisassis.integrationtests.testconstainers.AbstractIntegrationTest;import com.fasterxml.jackson.core.JsonProcessingException;import com.fasterxml.jackson.databind.DeserializationFeature;import com.fasterxml.jackson.databind.ObjectMapper;import io.restassured.builder.RequestSpecBuilder;import io.restassured.builder.ResponseSpecBuilder;import io.restassured.filter.Filter;import io.restassured.filter.log.LogDetail;import io.restassured.filter.log.RequestLoggingFilter;import io.restassured.filter.log.ResponseLoggingFilter;import io.restassured.specification.RequestSpecification;import lombok.extern.slf4j.Slf4j;import org.junit.jupiter.api.*;import org.junit.jupiter.api.extension.ExtendWith;import org.junit.runner.RunWith;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.boot.test.web.server.LocalServerPort;import org.springframework.http.MediaType;import org.springframework.test.annotation.DirtiesContext;import org.springframework.test.context.ActiveProfiles;import org.springframework.test.context.junit.jupiter.SpringExtension;import org.springframework.test.context.junit4.SpringRunner;import static io.restassured.RestAssured.given;import static junit.framework.TestCase.assertEquals;import static junit.framework.TestCase.assertNotNull;import static junit.framework.TestCase.assertTrue;import static org.junit.jupiter.api.Assertions.*;@Slf4j@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)@TestMethodOrder(MethodOrderer.OrderAnnotation.class)class PersonControllerTest extends AbstractIntegrationTest {    @LocalServerPort    private int port;    private static RequestSpecification specification;    private static ObjectMapper objectMapper;    private static PersonDTO person;    @BeforeAll    static void setUp() {        objectMapper = new ObjectMapper();        objectMapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);        person = new PersonDTO();    }    @Test    @Order(1)    void create() throws JsonProcessingException {        mockPerson();        specification = new RequestSpecBuilder()                .addHeader(TestConfigs.HEADER_PARAM_ORIGIN, TestConfigs.ORIGIN_ERUDIO)                .setBasePath("/api/person/v1")                .setPort(8888)                .addFilter(new RequestLoggingFilter(LogDetail.ALL))                .addFilter(new ResponseLoggingFilter(LogDetail.ALL))                .build();        var content = given(specification)                .contentType(MediaType.APPLICATION_JSON_VALUE)                    .body(person)                .when()                    .post()                .then()                .   statusCode(201)                .extract()                    .body()                        .asString();        PersonDTO createPerson = objectMapper.readValue(content, PersonDTO.class);        person = createPerson;        assertNotNull(createPerson.getId());        assertNotNull(createPerson.getFirstName());        assertNotNull(createPerson.getLastName());        assertNotNull(createPerson.getAddress());        assertNotNull(createPerson.getAddress());        assertTrue(createPerson.getId() > 0);        assertEquals("Elvis", createPerson.getFirstName());        assertEquals("Assis", createPerson.getLastName());        assertEquals("Rosário do Rio Grando - Minas Gerais - Brasil", createPerson.getAddress());        assertEquals("Male", createPerson.getGender());    }    @Test    @Order(2)    void createWithWrongOrigin() throws JsonProcessingException {        specification = new RequestSpecBuilder()                .addHeader(TestConfigs.HEADER_PARAM_ORIGIN, TestConfigs.ORIGIN_SEMERU)                .setBasePath("/api/person/v1")                .setPort(port)                .addFilter(new RequestLoggingFilter(LogDetail.ALL))                .addFilter(new ResponseLoggingFilter(LogDetail.ALL))                .build();        var content = given(specification)                .contentType(MediaType.APPLICATION_JSON_VALUE)                    .body(person)                .when()                    .post()                .then()                    .statusCode(403)                .extract()                    .body()                        .asString();        assertEquals("Invalid CORS request", content);    }    @Test    @Order(3)    void findById() throws JsonProcessingException {        specification = new RequestSpecBuilder()                .addHeader(TestConfigs.HEADER_PARAM_ORIGIN, TestConfigs.ORIGIN_LOCAL)                .setBasePath("/api/person/v1")                .setPort(TestConfigs.SERVER_PORT)                .addFilter(new RequestLoggingFilter(LogDetail.ALL))                .addFilter(new ResponseLoggingFilter(LogDetail.ALL))                .build();        var content = given(specification)                .contentType(MediaType.APPLICATION_JSON_VALUE)                    .pathParam("id", person.getId())                .when()                .   get("{id}")                .then()                    .statusCode(200)                .extract()                    .body()                        .asString();        PersonDTO createdPerson = objectMapper.readValue(content, PersonDTO.class);        person = createdPerson;        assertNotNull(createdPerson.getId());        assertNotNull(createdPerson.getFirstName());        assertNotNull(createdPerson.getLastName());        assertNotNull(createdPerson.getAddress());        assertNotNull(createdPerson.getGender());        assertTrue(createdPerson.getId() > 0);        assertEquals("Elvis", createdPerson.getFirstName());        assertEquals("Assis", createdPerson.getLastName());        assertEquals("Rosário do Rio Grando - Minas Gerais - Brasil", createdPerson.getAddress());        assertEquals("Male", createdPerson.getGender());    }    @Test    @Order(4)    void findByIdWithWrongOrigin() throws JsonProcessingException {        specification = new RequestSpecBuilder()                .addHeader(TestConfigs.HEADER_PARAM_ORIGIN, TestConfigs.ORIGIN_SEMERU)                .setBasePath("/api/person/v1")                .setPort(TestConfigs.SERVER_PORT)                .addFilter(new RequestLoggingFilter(LogDetail.ALL))                .addFilter(new ResponseLoggingFilter(LogDetail.ALL))                .build();        var content = given(specification)                .contentType(MediaType.APPLICATION_JSON_VALUE)                    .pathParam("id", person.getId())                .when()                    .get("{id}")                .then()                    .statusCode(403)                .extract()                    .body()                        .asString();        assertEquals("Invalid CORS request", content);    }    private void mockPerson() {        person.setFirstName("Elvis");        person.setLastName("Assis");        person.setAddress("Rosário do Rio Grando - Minas Gerais - Brasil");        person.setGender("Male");    }}